# yaml-language-server: $schema=state-model.json
type: StateModel
name: CrossLink Returnables State Model
desc: Requester/Supplier workflow per ISO18626, including NCIP integration and ISO status events.
version: "1.0.0"
states:
  # Requester-side
  - name: NEW
    display: New
    desc: Initial state after Patron Request is created (POST)
    side: REQUESTER
    actions:
      - name: validate
        desc: Validate patron via NCIP LookupUser (if enabled) or noop
        transitions: [VALIDATED]

  - name: VALIDATED
    display: Validated
    desc: Patron is validated via NCIP LookupUser (if enabled) or noop
    side: REQUESTER
    actions:
      - name: send-request
        desc: Post ISO18626 Request to the supplier (auto if configured)
        transitions: [SENT]

  - name: SENT
    display: Sent
    desc: Request is posted to the ISO18626 handler
    side: REQUESTER
    events:
      - name: expect-to-supply
        desc: Supplier indicates an intention to supply (ISO ExpectToSupply)
        transitions: [SUPPLIER_LOCATED]
      - name: will-supply
        desc: Supplier will supply without conditions (ISO WillSupply)
        transitions: [WILL_SUPPLY]
      - name: will-supply-conditional
        desc: Supplier will supply with conditions (ISO WillSupply with conditions)
        transitions: [CONDITION_PENDING]
      - name: loaned
        desc: Supplier shipped/loaned the item (ISO Loaned)
        transitions: [SHIPPED]
      - name: unfilled
        desc: Supplier cannot supply (ISO Unfilled)
        transitions: [UNFILLED]

  - name: SUPPLIER_LOCATED
    display: Supplier Located
    desc: After receiving ISO ExpectToSupply
    side: REQUESTER
    actions:
      - name: cancel-request
        desc: Send ISO Cancel request to supplier
        transitions: [CANCEL_PENDING]
    events:
      - name: will-supply
        desc: Supplier will supply without conditions (ISO WillSupply)
        transitions: [WILL_SUPPLY]
      - name: will-supply-conditional
        desc: Supplier will supply with conditions (ISO WillSupply with conditions)
        transitions: [CONDITION_PENDING]
      - name: unfilled
        desc: Supplier cannot supply (ISO Unfilled)
        transitions: [UNFILLED]

  - name: CONDITION_PENDING
    display: Condition Pending
    desc: After receiving ISO WillSupply with conditions
    side: REQUESTER
    actions:
      - name: accept-condition
        desc: Accept supplier conditions
        transitions: [WILL_SUPPLY]
      - name: reject-condition
        desc: Reject supplier conditions and send Cancel
        transitions: [CANCEL_PENDING]

  - name: WILL_SUPPLY
    display: Will Supply
    desc: After receiving ISO WillSupply (without condition)
    side: REQUESTER
    actions:
      - name: cancel-request
        desc: Send ISO Cancel request to supplier
        transitions: [CANCEL_PENDING]
    events:
      - name: loaned
        desc: Supplier shipped/loaned the item (ISO Loaned)
        transitions: [SHIPPED]
      - name: unfilled
        desc: Supplier cannot supply (ISO Unfilled)
        transitions: [UNFILLED]

  - name: SHIPPED
    display: Shipped
    desc: After receiving ISO Loaned
    side: REQUESTER
    actions:
      - name: receive
        desc: Receive and accept item in local ILS; send ISO Received
        transitions: [RECEIVED]

  - name: RECEIVED
    display: Received
    desc: Item received and accepted into local ILS (NCIP AcceptItem). ISO Received is sent.
    side: REQUESTER
    actions:
      - name: check-out
        desc: Check out item to patron (NCIP CheckOutItem)
        transitions: [CHECKED_OUT]

  - name: CHECKED_OUT
    display: Checked Out
    desc: Item is checked out to patron (NCIP CheckOutItem)
    side: REQUESTER
    actions:
      - name: check-in
        desc: Check in item from patron (NCIP CheckInItem)
        transitions: [CHECKED_IN]

  - name: CHECKED_IN
    display: Checked In
    desc: Item is checked back in (NCIP CheckInItem)
    side: REQUESTER
    actions:
      - name: ship-return
        desc: Send ISO ShippedReturn and delete temporary item (NCIP DeleteItem)
        transitions: [SHIPPED_RETURNED]

  - name: SHIPPED_RETURNED
    display: Shipped Returned
    desc: ISO ShippedReturn action is sent (NCIP DeleteItem)
    side: REQUESTER
    events:
      - name: completed
        desc: Supplier/broker signals loan/copy completion
        transitions: [COMPLETED]

  - name: CANCEL_PENDING
    display: Cancel Pending
    desc: ISO Cancel action is sent
    side: REQUESTER
    events:
      - name: cancel-accepted
        desc: Supplier accepts cancellation
        transitions: [CANCELLED]

  - name: COMPLETED
    display: Completed
    desc: Received LoanCompleted or CopyCompleted from the broker
    side: REQUESTER
    terminal: true

  - name: CANCELLED
    display: Cancelled
    desc: Cancel response is received
    side: REQUESTER
    terminal: true

  - name: UNFILLED
    display: Unfilled
    desc: After receiving Unfilled status
    side: REQUESTER
    terminal: true

  # Supplier-side
  - name: NEW
    display: New
    desc: Item is created on the supplier side for local fulfillment
    side: SUPPLIER
    actions:
      - name: validate
        desc: Validate institutional patron via NCIP LookupUser (if enabled)
        transitions: [VALIDATED]

  - name: VALIDATED
    display: Validated
    desc: Institutional patron validated via NCIP LookupUser (if enabled)
    side: SUPPLIER
    actions:
      - name: will-supply
        desc: Indicate supplier will supply and send ISO WillSupply
        transitions: [WILL_SUPPLY]
      - name: cannot-supply
        desc: Indicate cannot supply
        transitions: [UNFILLED]
      - name: add-condition
        desc: Indicate will supply with conditions
        transitions: [CONDITION_PENDING]
    events:
      - name: cancel-request
        desc: Requester sends ISO Cancel
        transitions: [CANCEL_REQUESTED]

  - name: WILL_SUPPLY
    display: Will Supply
    desc: After manual will-supply or successful auto-responder (e.g., RequestItem/availability)
    side: SUPPLIER
    actions:
      - name: add-condition
        desc: Add conditions and notify requester
        transitions: [CONDITION_PENDING]
      - name: ship
        desc: Mark shipped; send ISO Loaned; NCIP CheckOutItem
        transitions: [SHIPPED]
      - name: cannot-supply
        desc: Indicate cannot supply
        transitions: [UNFILLED]
    events:
      - name: cancel-request
        desc: Requester sends ISO Cancel
        transitions: [CANCEL_REQUESTED]

  - name: CONDITION_PENDING
    display: Condition Pending
    desc: Conditions are sent with a special ISO WillSupply
    side: SUPPLIER
    actions:
      - name: cannot-supply
        desc: Indicate cannot supply
        transitions: [UNFILLED]
    events:
      - name: conditions-accepted
        desc: Requester accepts conditions
        transitions: [CONDITION_ACCEPTED]
      - name: condition-rejected
        desc: Requester rejects conditions (auto-responder may mark unfilled)
        transitions: [UNFILLED]
      - name: cancel-request
        desc: Requester sends ISO Cancel
        transitions: [CANCEL_REQUESTED]

  - name: CONDITION_ACCEPTED
    display: Condition Accepted
    desc: After receiving conditions accepted notification
    side: SUPPLIER
    actions:
      - name: ship
        desc: Mark shipped; send ISO Loaned; NCIP CheckOutItem
        transitions: [SHIPPED]
      - name: cannot-supply
        desc: Indicate cannot supply
        transitions: [UNFILLED]
    events:
      - name: cancel-request
        desc: Requester sends ISO Cancel
        transitions: [CANCEL_REQUESTED]

  - name: SHIPPED
    display: Shipped
    desc: After marking shipped and sending ISO Loaned; NCIP CheckOutItem
    side: SUPPLIER
    events:
      - name: shipped-return
        desc: Requester sends ISO ShippedReturn
        transitions: [SHIPPED_RETURN]
      - name: cancel-request
        desc: Requester sends ISO Cancel
        transitions: [CANCEL_REQUESTED]

  - name: SHIPPED_RETURN
    display: Shipped Return
    desc: After receiving ISO ShippedReturn action
    side: SUPPLIER
    actions:
      - name: mark-received
        desc: Mark returned item received and complete (CheckInItem if configured)
        transitions: [COMPLETED]

  - name: CANCEL_REQUESTED
    display: Cancel Requested
    desc: After manual accept-cancellation or automatically after ISO Cancel if auto-cancellation is on
    side: SUPPLIER
    actions:
      - name: mark-cancelled
        desc: Confirm cancellation
        transitions: [CANCELLED]
      - name: will-supply
        desc: Resume supplying despite cancel request
        transitions: [WILL_SUPPLY]

  - name: COMPLETED
    display: Completed
    desc: After marking received and successful NCIP CheckInItem (if configured)
    side: SUPPLIER
    terminal: true

  - name: CANCELLED
    display: Cancelled
    desc: After marking cancelled or automatically if auto-cancellation is on
    side: SUPPLIER
    terminal: true

  - name: UNFILLED
    display: Unfilled
    desc: After manual cannot-supply or auto failure (RequestItem/availability/condition rejected)
    side: SUPPLIER
    terminal: true
